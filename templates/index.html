<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualización en Tiempo Real</title>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <style>
        body {
            font-family: Arial;
            margin: 80px 100px 10px 100px;
            padding: 0;
            color: #555;
            align-items: center;
        }
        .contenedor {
            height: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="contenedor">
        <h1>Visualización en Tiempo Real Sensor de luz y temperatura</h1>
        <div id="real-time-chart"></div>
        <br>
        <hr>
        <div class="ld-form">
            <div class="ld-row">
                <label class="ld-label">
                    Habilitar Actualización Automática
                </label>
                <input type="checkbox" checked="checked" id="enablePolling" />
            </div>
            <div class="ld-row">
                <label class="ld-label">
                    Frecuencia de Actualización (segundos)
                </label>
                <input class="ld-time-input" type="number" value="2" id="pollingTime" />
            </div>
        </div>
    </div>

    <script>
        var datoLuz = 0;
        var datoTemperatura = 0;

        // Definir la función onChartLoad
        const onChartLoad = function () {
            const chart = this,
                series = chart.series[0];

            setInterval(function () {
                const x = (new Date()).getTime(),
                    y = datoTemperatura;

                series.addPoint([x, y], true, true);
            }, 1000);
        };

        // Configuración del gráfico de Highcharts
        Highcharts.chart('real-time-chart', {
            chart: {
                type: 'spline',
                events: {
                    load: onChartLoad
                }
            },
            time: {
                useUTC: false
            },
            title: {
                text: 'Datos en Tiempo Real'
            },
            xAxis: {
                type: 'datetime',
                tickPixelInterval: 150,
                maxPadding: 0.1
            },
            yAxis: {
                title: {
                    text: 'Valor'
                },
                plotLines: [
                    {
                        value: 0,
                        width: 1,
                        color: '#808080'
                    }
                ]
            },
            tooltip: {
                headerFormat: '<b>{series.name}</b><br/>',
                pointFormat: '{point.x:%d-%m-%Y %H:%M:%S}<br/>{point.y:.2f}'
            },
            legend: {
                enabled: true
            },
            exporting: {
                enabled: false
            },
            series: [
                {
                    name: 'Luz',
                    lineWidth: 2,
                    color: Highcharts.getOptions().colors[0],
                    data: [] // Debes definir dataLuz con los datos correspondientes
                },
                {
                    name: 'Temperatura',
                    lineWidth: 2,
                    color: Highcharts.getOptions().colors[2],
                    data: [] // Debes definir dataTemperatura con los datos correspondientes
                }
            ]
        });

        // Función para realizar solicitudes HTTP periódicas y actualizar el gráfico
        function fetchDataAndUpdateChart() {
            // Coloca la URL correcta de la API para obtener los datos
            const apiUrl = '/api/get_last_data';

            fetch(apiUrl)
                .then(handleResponse)
                .then(updateChart)
                .catch(handleError)
                .finally(scheduleNextRequest);
        }

        function handleResponse(response) {
            if (!response.ok) {
                throw new Error(`Error de red: ${response.status}`);
            }
            return response.json();
        }

        function updateChart(data) {
            const { time, medicionLuz, medicionTemperatura } = JSON.parse(data);
            datoLuz = medicionLuz;
            datoTemperatura = +medicionTemperatura.toFixed(2);

            // Actualiza el gráfico con los nuevos datos
            const chart = Highcharts.charts[0];
            const x = (new Date()).getTime();
            const yLuz = datoLuz;
            const yTemp = datoTemperatura;

            chart.series[0].addPoint([x, yLuz], true, true);
            chart.series[1].addPoint([x, yTemp], true, true);

            console.log(JSON.parse(data));
        }

        function handleError(error) {
            console.error('Error al obtener datos:', error);
            datoLuz = null;
            datoTemperatura = null;
        }

        function scheduleNextRequest() {
            setTimeout(fetchDataAndUpdateChart, 1000); // Realiza la siguiente solicitud después de un segundo
        }

        // Inicia la función para realizar solicitudes HTTP periódicas
        fetchDataAndUpdateChart();
    </script>
</body>
</html>
